<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å®¤å…§ç«ç½ç…™æµè§€å¯Ÿå™¨ Pro v12</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* --- åŸºç¤è¨­å®š --- */
    body {
      font-family: "Helvetica Neue", Helvetica, Arial, "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
      text-align: center;
      margin: 0;
      background: #eef2f5;
      color: #333;
    }
    h2 { margin-top: 15px; color: #d32f2f; }

    /* --- æ§åˆ¶é¢æ¿ --- */
    .controls, .dataPanel { margin: 10px; }
    .dataPanel { font-size: 15px; font-weight: bold; background: #fff; display: inline-block; padding: 8px 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    button, select {
      padding: 8px 12px; margin: 3px; font-size: 14px;
      border: 1px solid #ccc; border-radius: 5px; background: #fff;
      cursor: pointer; transition: 0.2s;
    }
    button:hover { background: #e0e0e0; }
    button:active { transform: scale(0.98); }

    /* --- æˆ¿å±‹çµæ§‹ --- */
    .house-container {
      position: relative; width: 95%; max-width: 900px; height: 420px;
      margin: 15px auto; border: 4px solid #333; background: #fafafa;
      overflow: hidden; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      cursor: crosshair; /* æç¤ºä½¿ç”¨è€…å¯ä»¥é»æ“Šæ”¹è®Šèµ·ç«é» */
    }
    .wall { position: absolute; width: 10px; height: 350px; background: #555; top: 0; left: 50%; transform: translateX(-50%); z-index: 2; }
    .door { position: absolute; width: 10px; height: 90px; background: #8b4513; bottom: 0; left: 50%; transform: translateX(-50%); z-index: 3; border-radius: 2px; transition: background 0.3s; }
    .escapeLine { position: absolute; width: 100%; height: 2px; background: rgba(255,0,0,0.5); bottom: 180px; z-index: 1; border-dasharray: 5,5; }
    
    /* --- ç•«å¸ƒ --- */
    canvas { position: absolute; top: 0; left: 0; z-index: 1; pointer-events: none; }

    /* --- äººç‰© --- */
    .person { position: absolute; width: 15px; height: 40px; bottom: 0; left: 10%; z-index: 4; transition: height 0.3s; }
    .person .head { width: 15px; height: 15px; background: #ffcc99; border-radius: 50%; margin: 0 auto; }
    .person .body { width: 15px; height: 25px; background: #1976d2; border-radius: 5px 5px 2px 2px; margin-top: -1px; transition: background 0.3s, height 0.3s; }
    .person.crouch { height: 25px; }
    .person.crouch .body { height: 10px; background: #0d47a1; }
    .person.danger .body { background: #ff9800 !important; } /* å±éšªç‹€æ…‹ */

    /* --- æ’ç…™å£ --- */
    .vent {
      position: absolute; width: 35px; height: 15px; background: linear-gradient(to bottom, #ccc, #888);
      top: 5px; border-radius: 3px; z-index: 5; overflow: hidden; box-shadow: 0 0 5px rgba(0,0,0,0.5);
    }
    #ventLeft { left: 10px; }
    #ventRight { right: 10px; }
    .vent::after {
      content: ''; position: absolute; width: 100%; height: 2px; background: rgba(0,200,255,0.8);
      top: 50%; display: none; animation: flow 0.5s linear infinite;
    }
    .vent.on::after { display: block; }
    @keyframes flow { 0% { left: -100%; } 100% { left: 100%; } }
  </style>
</head>
<body>

  <h2>ğŸ”¥ å®¤å…§ç«ç½ç…™æµè§€å¯Ÿå™¨ Pro v12</h2>

  <div class="controls">
    <select id="intensity">
      <option value="1">ç«å‹¢ï¼šä½</option>
      <option value="2">ç«å‹¢ï¼šä¸­</option>
      <option value="3">ç«å‹¢ï¼šé«˜</option>
    </select>
    <button onclick="startFire()" style="background:#e3f2fd; font-weight:bold;">é–‹å§‹</button>
    <button onclick="resetSimulation()">é‡ç½®</button>
    <button onclick="toggleDoor()">é–€ é–‹/é—œ</button>
    <button onclick="toggleVent('L')">å·¦æ’ç…™ <span id="ventStatusL">é—œ</span></button>
    <button onclick="toggleVent('R')">å³æ’ç…™ <span id="ventStatusR">é—œ</span></button>
    <button onclick="toggleCrouch()">è¹²ä¸‹/ç«™ç«‹</button>
    <button onclick="speedUp()" id="btnSpeed">åŠ é€Ÿ ğŸ”¥ (1x)</button>
  </div>

  <div class="dataPanel">
    â± æ™‚é–“ï¼š<span id="time" style="color:#d32f2f;">0</span> ç§’ ï½œ 
    â˜ï¸ ç…™å±¤é«˜åº¦ï¼š<span id="smokeHeight">0</span> cm ï½œ 
    ğŸ§ äººç‰©é«˜åº¦ï¼š<span id="personHeight">180</span> cm
  </div>

  <div class="house-container" id="house" title="é»æ“Šç•«é¢ä»»æ„è™•å¯æ”¹è®Šèµ·ç«é»">
    <canvas id="fireCanvas"></canvas>
    <div class="wall"></div>
    <div id="door" class="door"></div>
    <div class="escapeLine" title="å±éšªç•Œç·š (180cm)"></div>
    <div class="person" id="person">
      <div class="head"></div>
      <div class="body"></div>
    </div>
    <div id="ventLeft" class="vent" title="å·¦å´æ’ç…™å£"></div>
    <div id="ventRight" class="vent" title="å³å´æ’ç…™å£"></div>
  </div>

  <audio id="ventSound" src="https://www.soundjay.com/mechanical/fan-01.mp3" loop></audio>

  <script>
    // --- DOM å…ƒç´ èˆ‡å…¨åŸŸè®Šæ•¸ ---
    const house = document.getElementById("house");
    const canvas = document.getElementById("fireCanvas");
    const ctx = canvas.getContext("2d");
    
    const ventSound = document.getElementById("ventSound");
    const person = document.getElementById("person");
    const ventL = document.getElementById("ventLeft");
    const ventR = document.getElementById("ventRight");

    let doorOpen = false, ventOnL = false, ventOnR = false, personCrouch = false;
    let interval = null, time = 0, speedFactor = 1;
    let smokeParticles = [], fireX = 0, fireIntensity = 1;
    let smokeLayer = []; // å¤©èŠ±æ¿ç…™å±¤åšåº¦é™£åˆ—

    // æ¯”ä¾‹å°ºè¨­å®š (æ ¹æ“šåŸç¨‹å¼ç¢¼æ¨ç®—)
    const pxPerCm = 0.2; // 1cm = 0.2px => 1px = 5cm
    const safetyHeightCm = 180;

    // --- åˆå§‹åŒ–èˆ‡è‡ªé©æ‡‰å¤§å° ---
    function initCanvas() {
      canvas.width = house.clientWidth;
      canvas.height = house.clientHeight;
      fireX = canvas.width * 0.15; // é è¨­èµ·ç«é»åœ¨å·¦å´ 15%
      smokeLayer = new Array(canvas.width).fill(0);
    }
    window.addEventListener('resize', initCanvas);
    initCanvas();

    // --- ç¹ªè£½ç«æº ---
    function drawFire() {
      fireIntensity += 0.01 * speedFactor;
      const numFlames = Math.floor(15 * Math.min(fireIntensity, 5)); // é™åˆ¶ç«ç„°ç¹ªè£½æ•¸é‡ä¸Šé™
      
      for (let i = 0; i < numFlames; i++) {
        const flameX = fireX + Math.random() * 20 - 10;
        const flameY = canvas.height - 40 - Math.random() * 30;
        const gradient = ctx.createRadialGradient(flameX, flameY, 2, flameX, flameY, 15);
        gradient.addColorStop(0, 'rgba(255, 255, 0, 0.9)');
        gradient.addColorStop(0.5, 'rgba(255, 165, 0, 0.7)');
        gradient.addColorStop(1, 'rgba(255, 0, 0, 0)');
        
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.moveTo(flameX, canvas.height - 40);
        ctx.lineTo(flameX - 8, flameY);
        ctx.lineTo(flameX + 8, flameY);
        ctx.fill();
      }
    }

    // --- ç”¢ç”Ÿç…™éœ§ç²’å­ ---
    function createSmokeParticles(intensity) {
      let num = 2 * intensity * Math.min(fireIntensity, 5);
      for (let i = 0; i < num; i++) {
        smokeParticles.push({
          x: fireX + Math.random() * 20 - 10,
          y: canvas.height - 40,
          vx: (Math.random() - 0.5) * 1.5,
          vy: -0.6 * 3 * speedFactor,
          size: 5 + Math.random() * 5,
          alpha: 0.6
        });
      }
    }

    // --- æ›´æ–°ç…™éœ§ç‰©ç†ç‹€æ…‹ ---
    function updateSmoke() {
      // å€’åºè¿´åœˆä»¥å®‰å…¨åˆªé™¤é™£åˆ—å…ƒç´ 
      for (let i = smokeParticles.length - 1; i >= 0; i--) {
        let p = smokeParticles[i];
        const doorTop = canvas.height - 40 - 90; // é–€çš„é«˜åº¦ä½ç½®

        // ç¢°åˆ°ä¸­é–“ç‰†å£æˆ–é–€çš„ç¢°æ’é‚è¼¯
        if (p.x > canvas.width / 2 - 5 && p.x < canvas.width / 2 + 5) {
          if (p.y < doorTop) { 
            p.vx *= -1; p.vy *= 0.8; 
          } else if (!doorOpen && p.y >= doorTop) { 
            p.vx *= -1; p.vy *= 0.8; 
          }
        }

        // ç¢°åˆ°æ’ç…™å£ (æ’ç…™å£å•Ÿå‹•æ™‚)
        const inLeftZone = p.x < canvas.width / 2;
        const inRightZone = p.x > canvas.width / 2;
        if ((ventOnL && inLeftZone) || (ventOnR && inRightZone)) {
          if (p.y < 35) { // é è¿‘å¤©èŠ±æ¿çš„æ’ç…™ç¯„åœ
            p.vy += 0.8 * speedFactor; // æ”¹è®Šæ–¹å‘å¾€ä¸‹æˆ–åŠ é€Ÿæ¶ˆæ•£
            p.alpha -= 0.05; 
          }
        }

        // ç²’å­ç§»å‹•
        p.x += p.vx * speedFactor;
        p.y += p.vy * speedFactor;

        // ç²’å­æŠµé”å¤©èŠ±æ¿ (è“„ç©æˆç…™å±¤)
        const ceilingLevel = 20;
        if (p.y < ceilingLevel) {
          const ix = Math.floor(p.x);
          if (ix >= 0 && ix < smokeLayer.length) {
            smokeLayer[ix] += 0.5 * speedFactor;
            // å¦‚æœæ’ç…™æ©Ÿé–‹å•Ÿï¼Œæ¸›å°‘è“„ç©é‡
            if ((ventOnL && inLeftZone) || (ventOnR && inRightZone)) {
              smokeLayer[ix] -= 0.6 * speedFactor; 
            }
            smokeLayer[ix] = Math.max(0, smokeLayer[ix]); // é¿å…åšåº¦è®Šç‚ºè² æ•¸
          }
          smokeParticles.splice(i, 1); // ç²’å­è½‰åŒ–ç‚ºç…™å±¤å¾Œç§»é™¤
          continue;
        }

        // è‡ªç„¶æ¶ˆæ•£
        p.alpha -= 0.002 * speedFactor;
        if (p.y < 0 || p.alpha <= 0) smokeParticles.splice(i, 1);
      }
    }

    // --- ç¹ªè£½ç•«é¢ ---
    function drawSmoke() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawFire();

      // 1. ç¹ªè£½å¤©èŠ±æ¿è“„ç©çš„ç…™å±¤
      for (let x = 0; x < smokeLayer.length; x++) {
        const h = smokeLayer[x];
        if (h > 0) {
          const layerAlpha = Math.min(0.8, h / 30);
          ctx.fillStyle = `rgba(50,50,50,${layerAlpha})`;
          ctx.fillRect(x, 0, 1, h + 20); // å¾é ‚éƒ¨å¾€ä¸‹ç•«
        }
      }

      // 2. ç¹ªè£½æµ®å‹•ç…™éœ§ç²’å­ï¼Œä¸¦è¨ˆç®—æœ€ä½ç…™å±¤é«˜åº¦
      let maxSmokePx = 0; // è¨˜éŒ„ç…™éœ§è·é›¢åœ°é¢çš„æœ€é«˜åƒç´  (å°æ‡‰æœ€åº•éƒ¨çš„ç…™)
      smokeParticles.forEach(p => {
        ctx.fillStyle = `rgba(50,50,50,${p.alpha})`;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, 2 * Math.PI);
        ctx.fill();
        maxSmokePx = Math.max(maxSmokePx, canvas.height - 40 - p.y);
      });

      // æ›ç®—ç‚ºå…¬åˆ†ä¸¦æ›´æ–°ä»‹é¢
      const currentSmokeHeightCm = Math.floor(maxSmokePx / pxPerCm);
      document.getElementById("smokeHeight").innerText = currentSmokeHeightCm;
    }

    // --- å®‰å…¨åˆ¤å®š ---
    function checkPersonSafety() {
      const personHeight = personCrouch ? 100 : 180;
      const smokeCm = parseInt(document.getElementById("smokeHeight").innerText);
      
      if (smokeCm > personHeight) {
        person.classList.add('danger'); // åƒåˆ°ç…™ï¼Œè®Šç‚ºå±éšªè‰²
      } else {
        person.classList.remove('danger');
      }
    }

    // --- æ ¸å¿ƒè¿´åœˆ ---
    function simulationLoop() {
      const intensity = parseInt(document.getElementById("intensity").value);
      time += (0.05 * speedFactor); // 50ms = 0.05s
      document.getElementById("time").innerText = time.toFixed(1);
      
      createSmokeParticles(intensity);
      updateSmoke();
      drawSmoke();
      checkPersonSafety();
    }

    // --- æŒ‰éˆ•æ§åˆ¶åŠŸèƒ½ ---
    function startFire() {
      clearInterval(interval);
      fireIntensity = 1;
      interval = setInterval(simulationLoop, 50);
    }

    function toggleDoor() {
      doorOpen = !doorOpen;
      document.getElementById("door").style.background = doorOpen ? '#4caf50' : '#8b4513';
    }

    function updateVentAudio() {
      if (ventOnL || ventOnR) {
        ventSound.play().catch(()=>console.log("Audio play prevented by browser policy"));
      } else {
        ventSound.pause();
        ventSound.currentTime = 0;
      }
    }

    function toggleVent(side) {
      if (side === 'L') {
        ventOnL = !ventOnL;
        document.getElementById('ventStatusL').innerText = ventOnL ? 'é–‹' : 'é—œ';
        ventL.classList.toggle('on', ventOnL);
      } else if (side === 'R') {
        ventOnR = !ventOnR;
        document.getElementById('ventStatusR').innerText = ventOnR ? 'é–‹' : 'é—œ';
        ventR.classList.toggle('on', ventOnR);
      }
      updateVentAudio();
    }

    function toggleCrouch() {
      personCrouch = !personCrouch;
      person.className = 'person' + (personCrouch ? ' crouch' : '');
      document.getElementById("personHeight").innerText = personCrouch ? 100 : 180;
      checkPersonSafety(); // ç«‹å³åˆ¤å®š
    }

    function speedUp() {
      speedFactor = speedFactor === 1 ? 2 : 1;
      document.getElementById("btnSpeed").innerText = `åŠ é€Ÿ ğŸ”¥ (${speedFactor}x)`;
    }

    function resetSimulation() {
      clearInterval(interval);
      time = 0; smokeParticles = []; 
      initCanvas(); // é‡æ–°åˆå§‹åŒ–ç•«å¸ƒèˆ‡ç…™å±¤é™£åˆ—
      fireIntensity = 1;
      doorOpen = false; ventOnL = false; ventOnR = false; personCrouch = false; speedFactor = 1;
      
      person.className = 'person';
      document.getElementById("door").style.background = '#8b4513';
      document.getElementById("ventStatusL").innerText = 'é—œ';
      document.getElementById("ventStatusR").innerText = 'é—œ';
      document.getElementById("time").innerText = '0.0';
      document.getElementById("smokeHeight").innerText = '0';
      document.getElementById("personHeight").innerText = '180';
      document.getElementById("btnSpeed").innerText = `åŠ é€Ÿ ğŸ”¥ (1x)`;
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ventL.classList.remove('on'); ventR.classList.remove('on');
      updateVentAudio();
    }

    // é»æ“Šæ”¹è®Šèµ·ç«é»
    house.addEventListener('click', (e) => {
      const rect = house.getBoundingClientRect();
      // é¿å…é»æ“Šæ’ç…™å£æ™‚æ”¹è®Šç«æº
      if(e.target.classList.contains('vent')) return; 
      fireX = e.clientX - rect.left;
    });

  </script>
</body>
</html>