<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>å®¤å…§ç«ç½ç…™æµäº’å‹•æ¨¡æ“¬ Pro v9</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:Arial;text-align:center;margin:0;background:#eef2f5;}
.controls{margin:5px;}
.house-container{position:relative;width:95%;max-width:900px;margin:10px auto;border:4px solid #333;background:#fafafa;overflow:hidden;height:420px;}
.wall{position:absolute;width:10px;height:350px;background:#555;top:0;left:50%;}
.stair{position:absolute;width:80px;height:100%;right:0;background:rgba(200,200,200,0.3);}
.door{position:absolute;width:10px;height:90px;background:brown;bottom:0;left:50%;z-index:2;border-radius:2px;}
.escapeLine{position:absolute;width:100%;height:2px;background:red;bottom:180px;z-index:3;}
.dataPanel{font-size:14px;margin:3px;}
button, select{padding:6px;margin:3px;font-family:Arial;}
canvas{position:absolute;top:0;left:0;z-index:1;}
.person{position:absolute;width:15px;height:40px;bottom:0;left:10%;z-index:4;}
.person .head{width:15px;height:15px;background:#ffcc99;border-radius:50%;margin:0 auto;}
.person .body{width:15px;height:25px;background:blue;border-radius:5px 5px 2px 2px;margin-top:-1px;}
.person.crouch .body{height:15px;background:darkblue;}
.person.crouch{height:30px;}
.vent{position:absolute;width:20px;height:20px;background:gray;right:10px;top:50px;border-radius:50%;z-index:5;}
</style>
</head>
<body>

<h2>ğŸ”¥ å®¤å…§ç«ç½ç…™æµäº’å‹•æ¨¡æ“¬ Pro v9</h2>

<div class="controls">
<select id="intensity">
<option value="1">ä½</option>
<option value="2">ä¸­</option>
<option value="3">é«˜</option>
</select>
<button onclick="startFire()">é–‹å§‹</button>
<button onclick="resetSimulation()">é‡ç½®</button>
<button onclick="toggleDoor()">é–€ é–‹/é—œ</button>
<button onclick="toggleVent()">æ’ç…™è¨­å‚™ é–‹/é—œ <span id="ventStatus">é—œ</span></button>
<button onclick="toggleCrouch()">è¹²ä¸‹/ç«™ç«‹</button>
</div>

<div class="dataPanel">
â± æ™‚é–“ï¼š<span id="time">0</span> ç§’ã€€
ç…™å±¤é«˜åº¦ï¼š<span id="smokeHeight">0</span> cmã€€
äººç‰©é«˜åº¦ï¼š<span id="personHeight">180</span> cm
</div>

<div class="house-container" id="house">
  <canvas id="fireCanvas"></canvas>
  <div class="wall"></div>
  <div class="stair"></div>
  <div id="door" class="door"></div>
  <div class="escapeLine"></div>
  <div class="person" id="person">
    <div class="head"></div>
    <div class="body"></div>
  </div>
  <div class="vent" id="vent"></div>
</div>

<audio id="ventSound" src="https://www.soundjay.com/mechanical/fan-01.mp3"></audio>

<script>
const house=document.getElementById("house");
const canvas=document.getElementById("fireCanvas");
canvas.width=house.clientWidth;
canvas.height=house.clientHeight;
const ctx=canvas.getContext("2d");

let doorOpen=false,ventOn=false,personCrouch=false;
let interval,time=0,smokeHeight=0;
let smokeParticles=[];
let fireX=house.clientWidth*0.15;
let fireIntensity=1;

const ventSound=document.getElementById("ventSound");
const person=document.getElementById("person");
const vent=document.getElementById("vent");

// 1 px = 5 cm
const pxPerCm=1/5; 
const safetyHeightCm=180;

// ğŸ”¥ ç«ç„°å‹•ç•«éç·šæ€§æˆé•·
function drawFire(){
  fireIntensity+=0.01; // è¶Šç‡’è¶Šæ—º
  const numFlames=Math.floor(15*fireIntensity);
  for(let i=0;i<numFlames;i++){
    const flameX=fireX+Math.random()*10-5;
    const flameY=canvas.height-40-Math.random()*30;
    const gradient=ctx.createRadialGradient(flameX,flameY,2,flameX,flameY,15);
    gradient.addColorStop(0,'yellow');
    gradient.addColorStop(0.5,'orange');
    gradient.addColorStop(1,'red');
    ctx.fillStyle=gradient;
    ctx.beginPath();
    ctx.moveTo(flameX,canvas.height-40);
    ctx.lineTo(flameX-5,flameY);
    ctx.lineTo(flameX+5,flameY);
    ctx.closePath();
    ctx.fill();
  }
}

// ğŸ”¹ ç…™ç²’å­ç³»çµ±
function createSmokeParticles(intensity){
  let num=2*intensity*Math.min(fireIntensity,5); 
  for(let i=0;i<num;i++){
    smokeParticles.push({
      x:fireX+Math.random()*20-10,
      y:canvas.height-40,
      vx:(Math.random()-0.5)*1.5,
      vy:-Math.random()*1.5-intensity*0.8,
      size:5+Math.random()*5,
      alpha:0.6
    });
  }
}

// ğŸ”¹ ç…™å±¤ç´¯ç©ï¼ˆå¤©èŠ±æ¿å¾€ä¸‹æ²‰ç©ï¼‰
let smokeLayer=[];
for(let i=0;i<canvas.width;i++) smokeLayer[i]=0;

function updateSmoke(){
  for(let i=smokeParticles.length-1;i>=0;i--){
    let p=smokeParticles[i];
    const doorTop=canvas.height-40-90; 
    const doorBottom=canvas.height-40;

    // é–€é˜»æ“‹
    if(p.x>canvas.width/2-5 && p.x<canvas.width/2+5){
      if(p.y<doorTop) { p.vx*=-1; p.vy*=0.8; }
      else if(!doorOpen && p.y>=doorTop) { p.vx*=-1; p.vy*=0.8; }
    }

    // å´é‚Šæ’ç…™å¸èµ°ç…™ç²’
    if(ventOn && p.x>canvas.width-30){
      p.vx-=0.5;
      p.alpha-=0.02;
    }

    p.x+=p.vx;
    p.y+=p.vy;

    // å¤©èŠ±æ¿ç´¯ç©
    const topPx=20; 
    if(p.y<topPx){
      const ix=Math.floor(p.x);
      if(ix>=0 && ix<smokeLayer.length){
        smokeLayer[ix]+=0.5; // ç´¯ç©åšåº¦
        if(ventOn) smokeLayer[ix]-=0.2; // æ’ç…™æ¸›å°‘åšåº¦
      }
      smokeParticles.splice(i,1);
      continue;
    }

    p.alpha-=0.002;
    if(p.y<0||p.alpha<=0) smokeParticles.splice(i,1);
  }
}

function drawSmoke(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawFire();

  // ç•«å¤©èŠ±æ¿ç´¯ç©ç…™å±¤ï¼ˆå¾€ä¸‹è“„ç©ï¼‰
  ctx.fillStyle='rgba(50,50,50,0.5)';
  for(let x=0;x<smokeLayer.length;x++){
    const h=smokeLayer[x];
    if(h>0) ctx.fillRect(x,20,h,1);
  }

  // ç•«ç²’å­
  smokeHeight=0;
  smokeParticles.forEach(p=>{
    ctx.fillStyle=`rgba(50,50,50,${p.alpha})`;
    ctx.beginPath();
    ctx.arc(p.x,p.y,p.size,0,2*Math.PI);
    ctx.fill();
    smokeHeight=Math.max(smokeHeight,canvas.height-40-p.y);
  });

  // cm å–®ä½
  const smokeCm=Math.floor(smokeHeight/pxPerCm);
  document.getElementById("smokeHeight").innerText=smokeCm;
}

// ğŸ”¹ æ¨¡æ“¬ä¸»è¿´åœˆ
function startFire(){
  const intensity=parseInt(document.getElementById("intensity").value);
  clearInterval(interval);
  fireIntensity=1;
  interval=setInterval(()=>{
    time++;
    document.getElementById("time").innerText=time;
    createSmokeParticles(intensity);
    updateSmoke();
    drawSmoke();
    checkPersonSafety();
  },50);
}

// ğŸ”¹ é–€
function toggleDoor(){
  doorOpen=!doorOpen;
  document.getElementById("door").style.background=doorOpen?'green':'brown';
}

// ğŸ”¹ æ’ç…™
function toggleVent(){
  ventOn=!ventOn;
  document.getElementById("ventStatus").innerText=ventOn?'é–‹':'é—œ';
  if(ventOn){ventSound.play();} else {ventSound.pause(); ventSound.currentTime=0;}
}

// ğŸ”¹ äººç‰©é«˜åº¦åˆ¤æ–·
function toggleCrouch(){
  personCrouch=!personCrouch;
  person.className='person'+(personCrouch?' crouch':'');
  document.getElementById("personHeight").innerText=personCrouch?100:180;
}

function checkPersonSafety(){
  const personHeight=parseInt(document.getElementById("personHeight").innerText);
  const smokeCm=parseInt(document.getElementById("smokeHeight").innerText);
  if(smokeCm>personHeight){
    person.querySelector(".body").style.background='orange';
  } else {
    person.querySelector(".body").style.background=personCrouch?'darkblue':'blue';
  }
}

// ğŸ”¹ ç§»å‹•ç«é»
house.addEventListener('click',e=>{
  const rect=house.getBoundingClientRect();
  fireX=e.clientX-rect.left;
});

function resetSimulation(){
  clearInterval(interval);
  time=0;
  smokeParticles=[];
  smokeLayer=[]; for(let i=0;i<canvas.width;i++) smokeLayer[i]=0;
  fireX=house.clientWidth*0.15;
  fireIntensity=1;
  doorOpen=false;
  ventOn=false;
  personCrouch=false;
  person.className='person';
  document.getElementById("ventStatus").innerText='é—œ';
  document.getElementById("time").innerText='0';
  document.getElementById("smokeHeight").innerText='0';
  document.getElementById("personHeight").innerText='180';
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ventSound.pause(); ventSound.currentTime=0;
}
</script>
</body>
</html>